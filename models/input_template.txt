{{ config(alias='{@source_table_name}') }}
{%- set model_name = '{@source_table_name}' | upper %}
{%- set ref_model_name = 'external__{@source_table_name}' %}
{%- set source_name = var('dictionary_database') %}

/* The external tables contain a columns "value" that contains the JSON document as a column. This CTE removes that column.
*/
WITH reduce_columns as
(
    Select 
        cycle_date
        {% set query %}
            select  
                source_column_name  
            from internal.dictionary 
            where 
                database_name='{{ var('dictionary_database') }}' and version_name='{{ var('dictionary_database_version') }}' 
                and source_table_name='{{model_name}}' 
            order by column_order
        {%- endset -%}

        {%- set columns = run_query(query) -%}        
        {%- for column in columns -%}
		, {{column.SOURCE_COLUMN_NAME}}
        {% endfor %}
    FROM 
        {{ source(source_name, ref_model_name ) }}
)
Select 
    SHA2(to_varchar(array_construct(*))) as row_hash
    {% set query %}
        select  
            source_column_name  
        from internal.dictionary 
        where 
            database_name='{{ var('dictionary_database') }}' and version_name='{{ var('dictionary_database_version') }}' 
            and source_table_name='{{model_name}}'  
            and delta_order is not null 
        order by delta_order
    {%- endset -%}
    {%- set columns = run_query(query) -%}        
    , MD5(to_varchar(array_construct(		   
    {%- for column in columns -%}
         {%- if not loop.first -%} , {%- endif -%}
    {{column.SOURCE_COLUMN_NAME}}
    {%- endfor -%}
    ))) as delta_hash
    , *
FROM reduce_columns
